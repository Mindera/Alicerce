language: swift
osx_image: xcode12.2

xcode_project: Alicerce.xcodeproj

addons:
  homebrew:
    brewfile: true

before_install:
  - gem install cocoapods

install: true

jobs:
  include:
    - stage: Build + Test
      env:
        - XCODE_WORKSPACE=Alicerce.xcworkspace
        - XCODE_PROJECT_NAME=Alicerce
        - XCODE_SDK=iphonesimulator
        - XCODE_ACTION='build test'
        - XCODE_DESTINATION='platform=iOS Simulator,name=iPhone 11 Pro,OS=latest'
        - XCODE_DERIVED_DATA_PATH=build
        - XCODE_SCHEME=Alicerce
      script:
        - set -o pipefail
        - xcodebuild $XCODE_ACTION -workspace "$XCODE_WORKSPACE" -scheme "$XCODE_SCHEME" -sdk "$XCODE_SDK" -destination "$XCODE_DESTINATION" -derivedDataPath "$XCODE_DERIVED_DATA_PATH" | xcpretty
      after_success:
        - bash <(curl -s https://codecov.io/bash) -D $XCODE_DERIVED_DATA_PATH -J "^$XCODE_SCHEME$"
    - stage: SwiftPM Build
      env:
        - PLATFORM_TARGET=x86_64-apple-ios14.0-simulator
      script:
        - swift build -Xswiftc "-sdk" -Xswiftc "`xcrun --sdk iphonesimulator --show-sdk-path`" -Xswiftc "-target" -Xswiftc "${PLATFORM_TARGET}"
    - stage: Pod lib lint
      script: 
        - pod repo update --silent
        - pod lib lint
    - stage: Deploy Github
      script: skip
      before_deploy:
        - carthage build --no-skip-current --cache-builds
        - carthage archive Alicerce
      deploy:
        - provider: releases
          api_key: $GITHUB_OAUTH_TOKEN
          file: Alicerce.framework.zip
          skip_cleanup: true
          overwrite: true
          on:
            repo: Mindera/Alicerce
            branch: master
            tags: true
    - stage: Deploy Cocoapods
      script: skip
      deploy:
        - provider: script
          script: pod trunk push --allow-warnings
          skip_cleanup: true
          on:
            repo: Mindera/Alicerce
            branch: master
            tags: true
